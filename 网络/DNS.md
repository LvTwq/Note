[TOC]



# 一、概念

域名系统（Domain Name System 或者 Domain Name Service 缩写 DNS，Domain Name被译为域名）。

作用：将人们熟悉的网址（域名）翻译成电脑可以理解的IP地址，这个过程称为 DNS 解析。

而且一个域名，往往对应多个DNS地址：

<img src="..\images\DNS.png" style="zoom: 67%;" />



# 二、经典面试题

## 1、浏览器中输入URL到返回页面的全过程？

俗称天龙八步：

- 1.根据域名，进行DNS域名解析；
- 2.拿到解析的IP地址，建立TCP连接；
- 3.向IP地址，发送HTTP请求；
- 4.服务器处理请求；
- 5.返回响应结果；
- 6.关闭TCP连接；
- 7.浏览器解析HTML；
- 8.浏览器布局渲染；



### DNS解析

<img src="..\images\DNS解析.png" style="zoom:67%;" />

如图所示，大致就是：

浏览器输入地址，然后浏览器这个进程去调操作系统某个库里的gethostbyname函数(例如，Linux GNU glibc标准库的gethostbyname函数)，然后呢这个函数通过网卡给DNS服务器发UDP请求，接收结果，然后将结果给返回给浏览器。

这张图其实已经讲明白大致的流程，但是细节上可能有些差异。

例如：

1）在用chrome浏览器的时候，其实会先去浏览器的dns缓存里头查询，dns 缓存中没有，再去调用gethostbyname函数

2）gethostbyname函数在试图进行DNS解析之前首先检查域名是否在本地 Hosts 里，如果没找到再去DNS服务器上查



## 2、UDP，TCP协议在哪里使用，DNS域名解析时用的是哪个？

需要补充的是：DNS中也有一个地方用到了TCP协议——区域传送！

DNS 规范中规定了两种类型的DNS服务器，一个是主DNS服务器，一个是辅助DNS服务器。在一个区域中，**主DNS服务器**从自己本机的**数据文件**中读取该区的DNS数据信息；而**辅助DNS服务器**则从**主DNS服务器**读取。

当一个辅助DNS服务器启动时，它需要与主DNS服务器通信，并加载数据信息，这个叫做区域传送。





## 3、域名解析为什么用UDP，区域复制为什么用TCP？

因为UDP快啊！

UDP的DNS协议只要一个请求、一个应答就好了。而使用基于TCP的DNS协议要三次握手、发送数据以及应答、四次挥手。但是UDP协议传输内容不能超过512字节。不过客户端向DNS服务器查询域名，一般返回的内容都不超过512字节，用UDP传输即可。

因为TCP协议可靠性好啊，传输的内容大！

要从主DNS上复制内容啊，不能用不可靠的UDP。
如果用最大只能传512字节的UDP协议？万一同步的数据大于512字节，怎么办？





# 三、原理

```shell
dig www.tmall.com
```

![](../images\DNS原理.png)

先看第一段，代表请求参数

![](..\images\DNS原理1.png)

DNS的查询参数一般有三个

1）域名：服务器、邮件服务器(邮件地址中 @ 后面的部分)的名称

2）Class：在设置DNS方案时，互联网之外的网络也考虑到了，而Class就是用来识别网络的，不过现在只有互联网，所以它的值永远都是代表互联网的IN

3）记录类型：标识域名对应何种类型的记录。类型为A，表示域名对应的是IP地址。类型为MX时，表示域名对应的是邮件服务器。类型为PTR，表示根据IP地址反查域名。类型为CNAME，表示查询域名相关别名。



## 1、DNS是怎么做域名解析的？

### 域名结构：

www.tmall.com 对应的真正的域名为www.tmall.com.

末尾的.称为根域名，因为每个域名都有根域名，因此我们通常省略。

根域名的下一级，叫做"顶级域名"（top-level domain，缩写为TLD），比如.com、.net；

再下一级叫做"次级域名"（second-level domain，缩写为SLD），比如www.tmall.com里面的.tmall，这一级域名是用户可以注册的；

再下一级是主机名（host），比如www.tmall.com里面的www，又称为"三级域名"，这是用户在自己的域里面为服务器分配的名称，是用户可以任意分配的。

**所以解析流程就是分级查询。**

1）现在本机的DNS里面查，如果存在就直接返回

![](..\images\本机DNS.png)

2）本机DNS里头发现没有，就去根服务器里查。根服务器发现这个域名是属于com域，因此根域DNS服务器会返回它所管理的com域中的DNS 服务器的IP地址，意思是“虽然我不知道你要查的那个域名的地址，但你可以去com域问问看”

3）本机的DNS接到又会向com域的DNS服务器发送查询消息。com 域中也没有www.tmall.com这个域名的信息，和刚才一样，com域服务器会返回它下面的tmall.com域的DNS服务器的IP地址。

以此类推，只要重复前面的步骤，就可以顺藤摸瓜找到目标DNS服务器。



第二段内容，也就是响应体

![](..\images\DNS2.png)

很明显，第一行就是说www.tmall.com这个域名地址拥有一个别名是www.tmall.com.danuoyi.tbcache.com。那么，很显然，后面几行就是这个www.tmall.com.danuoyi.tbcache.com地址的真实IP。

为什么天猫要设一个别名到www.tmall.com.danuoyi.tbcache.com地址呢？



## 2、为什么要用CNAME？

应该是方便cdn配置。