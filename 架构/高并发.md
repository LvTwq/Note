# 一、如何设计一个高并发系统


# 二、生产环境突发大流量导致服务不可用

## 第一阶段：快速恢复服务

* 先安抚客户，研发团队已经接入
* 确认现象：

  * 全部用户还是部分用户/区域（网络分区问题？）
  * 完全无法访问（502、504），还是部分接口超时
  * 关注监控指标：系统资源（CPU、内存、IO、带宽、数据库连接数）
* 定位瓶颈：

  * 入口层：nginx是否过载，连接数到达上限
  * 应用层：应用服务器的cpu、内存是否打满？
  * 依赖层：数据库（连接池满、慢SQL、死锁、主从延迟）、redis是否有大key
  * 网络层：带宽是否跑满？DDoS？
* “止血”措施：

  * 紧急扩容：增加服务实例
  * 流量管控：
    * 限流：直接对特定IP限流（iptables）
    * 降级：关闭非核心功能
    * 熔断：如果没有依赖服务已经不可用，则快速失败，避免雪崩（逃逸模式）
  * 数据库应急：
    * kill慢查询
    * 临时增加连接数
    * 读写分离
  * redis应急：
    * 手动删除大key
    * 手动加载某个key

## 第二阶段：定位根本原因

* 数据收集：
  * 监控数据：CPU、内存、数据库
* 日志分析：
  * 慢查询/死锁：优化sql
  * nginx日志：哪个接口qps最高
  * 应用日志：不合理的操作（死循环、资源未释放）
  * redis：大key、缓存雪崩、击穿
  * 爬虫攻击：user-agent、ip是否集中
